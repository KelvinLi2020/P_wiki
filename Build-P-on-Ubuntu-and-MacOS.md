## Components

The P repository contains three major components:

1. The P compiler itself (located in `Src/Pc`), which takes P code and produces code in either C or C#.

2. The P runtime for the C target (located in `Src/Prt`).

3. The P runtime for the C# target (located in `Src/PSharpRuntime/PSharpExtensions`), which is built as an extension to the [P# project](https://github.com/p-org/psharp)

## Tool Dependencies

You must acquire and install these dependencies yourself.

1. [Microsoft .NET Core 2.1 SDK](https://dotnet.microsoft.com/download/dotnet-core/2.1)

2. A recent Java JRE (to run the [ANTLR](https://www.antlr.org/) parser generator)

   On Ubuntu this can be installed via apt: `sudo apt-get install default-jre`

   On MacOS an installer can be downloaded from the [official Java downloads page](https://java.com/en/download/manual.jsp)

3. CMake (version â‰¥ 2.8) (used to build the C runtime)

   On Ubuntu this can be installed via apt: `sudo apt-get install cmake`

   On MacOS an installer can be downloaded from the [official CMake downloads page](https://cmake.org/download/)

4. A C++ compiler like `g++` or `clang++` (used to build the C runtime)

## Getting the Bits

```Bash
# This will create a directory 'P' in the current working directory
git clone https://github.com/p-org/P.git
cd P
```

## Building the Compiler

Open a terminal prompt and navigate to the `P` directory you cloned from GitHub.  To build the P compiler, run:

```Bash
./Bld/build-compiler.sh
```

This will place the compiler at the path `./Bld/Drops/Release/Binaries/Pc.dll`.  The compiler is a .NET Core application, so you can run it via the `dotnet` command:

```
dotnet ./Bld/Drops/Release/Binaries/Pc.dll PFile1.p PFile2.p ...
```

## Building the C Runtime

All C code generated by the P compiler depends on the C runtime library for P.  When you build C code generated by the P compiler, you will need to link against this library.

To build the C runtime library for P, open a terminal prompt and navigate to the `P` directory you cloned from GitHub, then run:

```Bash
./Bld/build-c-runtime.sh
```

This will place the C runtime libraries for P in the directory `./Bld/build`.  (**TODO: How should you link against these libaries when compiling P projects targeting C?**)

## Building the C# Runtime

All C# code generated by the P compiler depends on the C# runtime library for P.  When you build C# code generated by the P compiler, you will need to reference this library.  The project file for the C# runtime is located at [`Src/PSharpRuntime/PSharpExtensions/PrtSharp.csproj`](https://github.com/p-org/P/blob/master/Src/PSharpRuntime/PSharpExtensions/PrtSharp.csproj).

To include this library, add a `<ProjectReference ...>` line in the project file used to build your generated C# code.  This will look like:

```XML
<ProjectReference Include="[path to P repository]\Src\PSharpRuntime\PSharpExtensions\PrtSharp.csproj"/>
```

For a full example of how to build a P project targeting C#, see the [`TwoPhaseCommit` sample](https://github.com/p-org/P/tree/master/Src/Samples/TwoPhaseCommit).  The most important files to understand the build process are the `build.sh` script, which builds the entire `TwoPhaseCommit` project, and the `TwoPhaseCommit.csproj` file, which configures the build process for the C# code generated by the P compiler.


## Common Issues and Solutions

**'Prt.h' Not Found**

This issue is caused by incorrectly linking the C runtime libraries with cmake. Make sure to have all the library files under `./Bld/Drops/Prt/include/` included in your `CMakeList.txt`. For a full example of how to build a P project targeting C, see the `CMakeList.txt` file in the [`TwoPhaseCommit` sample](https://github.com/p-org/P/tree/master/Src/Samples/TwoPhaseCommit).

**Invalid Platform Specified**

This error is caused by missing the user platform environment variable and can be fixed by going to `PrtConfig.h` and selecting LinuxUserConfig by adding `#include "PrtLinuxUserConfig.h"`.
